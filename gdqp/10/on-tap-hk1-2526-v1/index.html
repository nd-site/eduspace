<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Đang nạp bài tập...</title>
    <!-- Giả lập nạp data.js (Nếu file tồn tại trên server) -->
    <script src="data.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="icon" href="/logo.png" type="image/x-icon">
    <script src="/nd-navbar.js" defer></script></head>
<body class="bg-blue-50">
    <div id="app-root">
        <div class="flex justify-center items-center h-screen font-sans text-blue-900">
            <div class="text-center">
                <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-900 mx-auto mb-4"></div>
                <p>Đang đồng bộ giao diện và dữ liệu...</p>
            </div>
        </div>
    </div>

    <script>
        /**
         * Logic nạp giao diện và đồng bộ dữ liệu
         */
        async function loadViewer() {
            try {
                // 1. Lấy nội dung giao diện từ template.html
                // Lưu ý: fetch('/') có thể lỗi nếu chạy trực tiếp từ file (file://)
                const response = await fetch('/eduspace/template.html');
                if (!response.ok) throw new Error("Không thể tải template.html");
                
                const htmlText = await response.text();

                // 2. Phân tích nội dung để trích xuất
                const parser = new DOMParser();
                const doc = parser.parseFromString(htmlText, 'text/html');

                // 3. Cập nhật Tiêu đề trang từ quizData (nạp từ data.js)
                if (typeof quizData !== 'undefined' && quizData.config) {
                    document.title = quizData.config.subject || "Bài tập";
                }

                // 4. Đồng bộ CSS/Styles từ template vào Head
                const headElements = doc.querySelectorAll('link[rel="stylesheet"], style');
                headElements.forEach(el => {
                    document.head.appendChild(el.cloneNode(true));
                });

                // 5. Thay thế nội dung body
                document.body.innerHTML = doc.body.innerHTML;

                // 6. Thực thi các script logic của template
                // Cần tạo thẻ script mới vì innerHTML không thực thi script
                const scripts = doc.querySelectorAll('script');
                for (const oldScript of scripts) {
                    const newScript = document.createElement("script");
                    
                    // Sao chép thuộc tính
                    Array.from(oldScript.attributes).forEach(attr => {
                        newScript.setAttribute(attr.name, attr.value);
                    });
                    
                    // Sao chép nội dung
                    newScript.text = oldScript.text;
                    
                    // Đợi nạp nếu là script ngoài, hoặc chạy ngay nếu inline
                    if (newScript.src) {
                        await new Promise((resolve) => {
                            newScript.onload = resolve;
                            newScript.onerror = resolve;
                            document.body.appendChild(newScript);
                        });
                    } else {
                        document.body.appendChild(newScript);
                    }
                }

                // 7. Kích hoạt sự kiện load nếu template cần
                window.dispatchEvent(new Event('load'));
                if (typeof window.onload === 'function') {
                    window.onload();
                }

            } catch (error) {
                console.error("Lỗi khi nạp giao diện:", error);
                document.getElementById('app-root').innerHTML = `
                    <div class="p-8 text-red-600 font-bold text-center">
                        Lỗi: ${error.message}<br>
                        <small class="font-normal text-gray-500">Đảm bảo bạn đang chạy trên Server hoặc template.html nằm cùng thư mục.</small>
                    </div>
                `;
            }
        }

        // Khởi chạy
        loadViewer();
    </script>
</body>
</html>